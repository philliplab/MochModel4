---
title: "MochModel4 Tests"
author: "Phillip Labuschagne"
date: "Tuesday, July 22, 2014"
output: html_document
---

## Setup and Run Model

### Folders and scenario creation

```{r, include=FALSE}
rm(list = ls())
rerun_models <- FALSE
options(scipen=999)
library(modgenTester)
library(knitr)
opts_chunk$set(echo = FALSE)
sd <- "C:/Users/Administrator/Documents/Visual Studio 2010/Projects/MochModel4"
td <- "C:/Users/Administrator/Documents/Visual Studio 2010/Projects/MochModel4/test"

copy_model(sd, 'MochModel4.exe', td)
copy_scenario(sd, 'Base.scex', 'Base(MotherCore).dat', td)
```

```{r}
scenarios_to_create <- list(
  '1' = list(test_folder = td, 
             base_scenario = 'Base.scex', 
             base_scenario_dat = 'Base(MotherCore).dat',
             scenario_name_sub = list(from = 'Base', to = 'Small'), 
             scex_sub = list(), 
             dat_sub = list('1' = list(from = 'int\tStartingPopulationSize = 10000;',
                                       to = 'int\tStartingPopulationSize = 1000;')
                            )
             ),
  '2' = list(test_folder = td, 
             base_scenario = 'Base.scex', 
             base_scenario_dat = 'Base(MotherCore).dat',
             scenario_name_sub = list(from = 'Base', to = 'NoHIV'), 
             scex_sub = list(), 
             dat_sub = list('1' = list(from = 'IncidenceMotherMultiplier = 1',
                                       to = 'IncidenceMotherMultiplier = 0')
                            )
             ))
for (i in scenarios_to_create){
  do.call(generate_scenario, i)
}
```

```{r}
available_scenarios <- list_all_scenarios(td, FALSE)
```

### Run modgen on all scenarios

```{r, eval=rerun_models}
for (scenario in available_scenarios){
  print(scenario)
  run_scenario(td, scenario$scex,
               td, "MochModel4.exe")
}
```

```{r}
all_results <- list_all_results(td)
```

### List available results

```{r}
db_channels <- list()
for (i in all_results){
  print(i)
  db_channel <- access_database(i)
  scenario_name <- gsub("\\(.*$", "", gsub("^.*/", "", i))
  db_channels[[scenario_name]] <- db_channel
  print('Parameter Tables:')
  print(list_parameter_tables(db_channel))
  print('Result Tables:')
  print(list_result_tables(db_channel))
}
```

### Some utility functions that will soon be merged into the package
```{r}
test_results <- list()

new_test <- function(test_results, name, scenarios = NULL, result = NULL, description = NULL){
  anchor_link <- gsub(" ", "", name)
  test_results[[name]] <- list(name = name,
                               result = result,
                               scenarios = scenarios, 
                               anchor_link = anchor_link)
  cat(paste0('### <a name="', anchor_link,'"></a>', name, "\n\n"))
  cat(paste0("Scenario(s): ", scenarios, "\n\n"))
  cat(paste0(description, '\n\n'))
  return(test_results)
}

new_result <- function(test_results, name, result){
  test_results[[name]][['result']] <- result
  cat(paste0("**Result: ", result, "** \n\n"))
  cat('---\n\n')
  return(test_results)
}

print_test_results <- function(test_results){
  cat("|Name|Result|Scenarios|\n")
  cat("|:-:|:-:|:-:|\n")
  for (i in test_results){
    cat(paste0("|[", i$name, "](#", i$anchor_link, ")|", i$result, "|", paste(i$scenarios, collapse = ", "), " \n"))
  }
}
```

### Helper functions - should maybe be packaged?

```{r}
get_mother_population_size <- function(db_channel){
  DurationOfLife <- as.data.frame(new_RTable("DurationOfLife", db_channel))
  return(subset(DurationOfLife, 
                metrics == "Population size", 
                select = 'Value')[1,1])
}
```

```{r}
ModelVersion <- as.data.frame(new_RTable("ModelVersion", db_channels$NoHIV))$Value[1]
```

## Tests for Model Version `r ModelVersion`

```{r, results='asis'}
ctest_name <- 'Life Expectancy Healthy Mother'
cscenarios <- 'NoHIV'
test_results <- new_test(test_results, 
                         name = ctest_name,
                         scenarios = cscenarios,
                         description = "In the case of no sickness, we expect the mother's life expectancy to be between 60 and 70")
```

```{r}
DurationOfLife <- as.data.frame(new_RTable("DurationOfLife", db_channels$NoHIV))
print(DurationOfLife)
x <- subset(DurationOfLife, 
            metrics == "Life expectancy", 
            select = 'Value')[1,1]
result <- x > 60 & x < 70
```

```{r, results='asis'}
test_results <- new_result(test_results,
                         name = ctest_name,
                         result = result)
rm('ctest_name', 'cscenarios', 'result')
```



```{r, results='asis'}
ctest_name <- 'Mother Max Age'
cscenarios <- 'Base'
test_results <- new_test(test_results,
                         name = ctest_name,
                         scenarios = cscenarios,
                         description = "The max age of a mother cannot be greater than 92")
```

```{r}
DurationOfLife <- as.data.frame(new_RTable("DurationOfLife", db_channels$Base))
print(DurationOfLife)
x <- subset(DurationOfLife, 
            metrics == "Maximum duration of life", 
            select = 'Value')
result <- x <= 92
```

```{r, results='asis'}
test_results <- new_result(test_results,
                         name = ctest_name,
                         result = result)
rm('ctest_name', 'cscenarios', 'result')
```



```{r, results='asis'}
ctest_name <- 'Percentage ever infected bounded'
cscenarios <- 'Base'
test_results <- new_test(test_results,
                         name = ctest_name,
                         scenarios = cscenarios,
                         description = "The percentage of mothers ever infected in the base case should be between 40 and 50%")
```

```{r}
Incidence <- as.data.frame(new_RTable("Incidence", db_channels$Base))
new_infections <- subset(Incidence, metrics == "Number of new infections", select = 'Value')$Value
total_infections <- sum(new_infections)
total_population <- get_mother_population_size(db_channels$Base)
percentage_ever_infected <- total_infections / total_population
print(list(total_infections = total_infections,
           total_population = total_population))
result <- percentage_ever_infected > 0.4 & percentage_ever_infected < 0.5
```

```{r, results='asis'}
test_results <- new_result(test_results,
                         name = ctest_name,
                         result = result)
rm('ctest_name', 'cscenarios', 'result')
```



```{r, results='asis'}
ctest_name <- 'Percentage ever infected zero in NoHIV'
cscenarios <- 'NoHIV'
test_results <- new_test(test_results,
                         name = ctest_name,
                         scenarios = cscenarios,
                         description = "The number of mothers ever infected in the NoHIV case should be 0")
```

```{r}
Incidence <- as.data.frame(new_RTable("Incidence", db_channels$NoHIV))
new_infections <- subset(Incidence, metrics == "Number of new infections", select = 'Value')$Value
total_infections <- sum(new_infections)
print(list(total_infections = total_infections))
result <- total_infections == 0
```

```{r, results='asis'}
test_results <- new_result(test_results,
                         name = ctest_name,
                         result = result)
rm('ctest_name', 'cscenarios', 'result')
```



```{r, results='asis'}
ctest_name <- 'Infected vs Healthy Mortality'
cscenarios <- 'Base'
test_results <- new_test(test_results,
                         name = ctest_name,
                         scenarios = cscenarios,
                         description = "The mortality of uninfected mothers must be lower than the mortality of uninfected mothers. Mortality is tricky to measure accurately thus a proxy is used. Total deaths from state is compared to the total years spent in the state for each state. Further refinements should be made to this test")
```

```{r}
Mortality <- as.data.frame(new_RTable("Mortality", db_channels[[cscenarios]]))
total_time_in_healthy <- sum(subset(Mortality, metrics == "Healthy Population", select = 'Value')$Value)
total_time_in_infected <- sum(subset(Mortality, metrics == "Infected Population", select = 'Value')$Value)
deaths_in_healthy <- sum(subset(Mortality, metrics == "Death from Healthy State", select = 'Value')$Value)
deaths_in_infected <- sum(subset(Mortality, metrics == "Death from Infected States", select = 'Value')$Value)
crude_healthy_mortality <- deaths_in_healthy / total_time_in_healthy
crude_infected_mortality <- deaths_in_infected / total_time_in_infected

print(list(
total_time_in_healthy = total_time_in_healthy,
total_time_in_infected = total_time_in_infected,
deaths_in_healthy = deaths_in_healthy,
deaths_in_infected = deaths_in_infected,
crude_healthy_mortality = crude_healthy_mortality,
crude_infected_mortality = crude_infected_mortality 
))
result <- crude_healthy_mortality < crude_infected_mortality
```

```{r, results='asis'}
test_results <- new_result(test_results,
                         name = ctest_name,
                         result = result)
rm('ctest_name', 'cscenarios', 'result')
```






## Summary of all tests

```{r, results='asis'}
print_test_results(test_results)
```
